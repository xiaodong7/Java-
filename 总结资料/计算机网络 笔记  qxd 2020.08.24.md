## 计算机网络 笔记  qxd 2020.08.24

[toc]

**主要参考来源**

[【计算机网络】第一章：计算机网络概述描述](https://blog.csdn.net/iwanderu/article/details/103795715)

[第六章【应用层】](https://blog.csdn.net/qq_45260767/article/details/106468547)



### 第一章   计算机网络概述

#### 1.1  OSI参考模型

```java
 应用层—— 所有能产生网络流量的程序
 表示层—— 在传输之前是否进行加密 或 压缩 处理，二进制或ASCII码表示
 会话层—— 查木马，看需求端和网站之间的连接
 传输层—— 可靠传输，流量控制，不可靠传输(一个数据包即可，不需要建立会话，例如向DNS查询网  站IP地址)
 网络层—— 负责选择最佳路径，规划IP地址(ipv4和ipv6变化只会影响网络层)
 数据链路层—— 帧的开始和结束，还有透明传输，差错校验(纠错由传输层解决)
 物理层—— 定义网络设备接口标准，电气标准(电压)，如何在物理链路上传输的更快
```

#### 1.2  计算机网络性能

(1)速率

> 连接在计算机网络上的主机在数字信道上传送数据位数的速率，也称data rate或bit rate(比特率)，单位是b/s, kb/s, Mb/s, Gb/s。和正常理解的网速的关系是除以8.

(2)带宽

> 数据通信领域中，数字信道所能传送的最高数据率，单位是b/s, kb/s, Mb/s, Gb/s。常见的是Mpbs。

(3)吞吐量

> 在单位时间内通过某个网络的数据量，单位是b/s, Mb/s。

(4)时延

> 包括发送时延，传播时延，处理时延，排队时延。发送时延等于数据块长度(bit)除以信道带宽(bit/s). 更快的发送速度意味着波长越短，链路上的数据量更大；更快的传播速度意味着在网线中更快的传播速度。

总时延=传播时延+发送时延+处理时延+排队时延

(5)时延X带宽(时延带宽积)

> 有多少数据正在线路上。

(6)往返时间

> 从发送方发送数据开始，到发送方收到接收方确认数据的时间。例如ping一下。

(7)利用率:

> 包括信道利用率：有数据通过的时间/总时间
>  网络利用率：信道利用率的加权平均
>  网络当前时延D = 网络空闲时时延D0 / (1 - 信道利用率U)

#### 1.3  **五层协议对应的数据单元**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200413120445394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



<font color=#00FFFF size=3>在应用层交互的数据叫报文，报文经过运输层（TCP/UDP）转换成段，然后在网络层经过路径选择，在首部添加IP地址变成数据包（也叫**IP数据报**），在数据链路层加上MAC地址组装成**帧**，在物理层传输时加上帧头帧位变成比特流。</font>



> - 应用层：能够产生**网络流量**能够和用户交互的应用程序（如QQ，但是记事本不算）
> - 表示层：加密 压缩  （开发人员应考虑）
> - 会话层：服务和客户端建立会话
>   - 查木马  netstat -nb（要用管理员身份运行cmd）
>   - 查看建立的会话 netstat -n
> - 传输层：可靠传输（建立会话） 不可靠传输（不建立会话） 流量控制
> - 网络层：IP地址编址，选择最佳路径
> - 数据链路层：数据如何封装，添加物理层地址MAC
> - 物理层：电压 接口标准

<font color=#00FFFF>路由器：</font>

- 在路由 器中的输入和输出端口之间**没有直接连线**。

- 路由器处分组的过程是：

  - 把收到的分组先放入**缓存**（暂时存储）；
  - 查找**转发表**，找出到某个目的地址应从哪个端口转 发；
  - 把分组送到适当的**端口转发**出去。

  

***



### 第二章   物理层 

#### 2.1  **物理层定义的标准**

物理层解决如何在链接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。
 物理层的主要任务：确定传输媒体的接口的一些特性，包括，
 机械特性：接口形状，大小，引线数量
 电气特性：例如规定电压范围(-5V-5V)
 功能特性：例如规定-5V上0，+5V是1
 过程特性：也称规程特性，规定建立连接时各个相关部件的工作步骤



目的：启动、维护和关闭数据链路实体之间进行比特传输的物理连接

ADSL (Asymmetric Digital Subscriber Line)：非对称数字用户线

> **香农公式**： C  = W log2(1 + S / N) b/s
>  ->W是信道的带宽(Hz)；
>  ->S是信道内所传信号的平均功率；
>  ->N是信道内的Gauss噪声的功率。
>  可以发现，减少速度和增大功率能提高准确度。
>  信道的带宽或信道中的信噪比(S/N)越大，则信息的极限传输速率C就越高；



***



### 第三章   数据链路层

#### 3.1  **数据链路层的简单模型**

数据链路层不关心物理层解决的问题，只关心帧头帧尾和校验。

![img](https://img-blog.csdnimg.cn/20200102231430200.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70)



主机H1向主机H2发送信息，数据从应用层向下流动，到达物理层变成比特流，经过路由器转发，通过检查MAC地址，查看IP地址，然后选择路由，找到下一个地址，再向下到物理层，这样经过路由器转发，到达主机H2。

**数据链路使用的信道主要分两种类型**：

(1)  **点对点信道**：使用**一对一**的通信方式。

(2 ) **广播信道**：使用**一对多**的广播通信方式，过程比较复杂。



- **链路（link）**：从一个节点到相邻结点的一段**物理线路（有线或无线**），中间没有任何其他的交换结点。
- **数据链路（data link）**：传输数据时需要一些必要的**通信协议**来控制数据的传输，把实现这些协议的硬件和软件加到链路上就构成了数据链路。



![img](https://img-blog.csdnimg.cn/20200426115727293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

现在常用的适配器（网卡）来实现这些协议的软硬件，一般的适配器都包括数据链路层和物理层两层的功能。

点对点信道的数据链路层协议的**数据单元——帧**

#### 3.2  **三个基本问题**

（1）**封装成帧**

将一段数据前后分别添加**首部和尾部**，这样就构成了一个帧，首部和尾部一个重要作用就   是进行**帧定界**。

帧数据部分的长度上限——最大传送单元MTU

![img](https://img-blog.csdnimg.cn/20200426122538326.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

帧定界可以使用特殊的帧定界符：
 控制字符SOH（Start Of Header）:放在帧最前面，表示帧的首部
 控制字符EOT（End Of Transmission）:表示帧的结束。



![img](https://img-blog.csdnimg.cn/20200426123128531.png)



(2)透明传输

当我们传输的数据部分出现了EOT或者SOH这样的帧定界控制字符时，可能导致数据被意外丢弃，这时就需要透明传输。

![img](https://img-blog.csdnimg.cn/20200426123431124.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



用字节填充法解决透明传输问题。发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(十六进制数1B)。
 字节填充(byte stuffing)或字符填充(character stuffing)——接收端的数据链路层在数据送往网络层之前删除插入的转义字符。
 如果转义字符也出现在数据之中，那么应该在转义字符前插入一个转义字符。当接收端收到连续的两个转义字符时，就删除前面的那一个。

![img](https://img-blog.csdnimg.cn/20200426123952526.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



(3)差错检验

传输中可能产生**比特差错**，1变成0,0变成1。在一段时间内，传输错误的比特占所用传输比特总数的比率称为**误码率**BER。
 数据链路层广泛使用**循环冗余检验**CRC

**要做到可靠传输，必须加上确认和重传机制**

#### 3.3  **两种情况下的数据链路层**

1. **使用点对点信道的数据链路层(广域网)**

（1）PPP协议(point to point protocol)，是数据链路层协议，例如用户使用拨号上网。

（2）PPP协议应该满足：

> - 简单（首要的要求）
> - 封装成帧
> - 透明性
> - 多层网络协议：同一条物理链路上同时支持多种网络层协议（如IP和IPX等）的运行。
> - 多种类型链路（PPPoE）
> - 差错检验
> - 检测连接状态
> - 最大传送单元
> - 网络层地址协商
> - 数据压缩协商

(3)PPP协议不需要满足：
 纠错；流量控制；序号；多点链接；半双工或单工连接。
 (4)PPP协议的组层部分：
 数据链路层协议可以用于异步串行或同步串行介质；
 使用LCP(链路控制协议)建立并维护数据链路连接，可以实现身份验证和欠费管理；
 网络控制协议(NCP)允许在点到点连接上使用多种网络层协议，如下图；

![img](https://img-blog.csdnimg.cn/2020010223174734.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70)

（5）**PPP协议的组成**

PPP协议有三个组成部分：
 1.一个将**IP数据报封装到串行链路**的方法
 2.一个用来建立、配置和测试数据链路连接的**链路控制协议**LCP（Link Control Protocol）
 3.一套**网络控制协议**NCP（Network Control Protocol），其中每个协议支持不同的网络层协议。

2. **PPP协议的帧格式**

PPP帧的首部和尾部分别有四个字段和两个字段

- 首部第一个字段和尾部第二个字段是标志字段F，规定为0x7E，标志字段表示一个帧的开始或结束。
- 地址字段A（0xFF）和C（0x03）实际不起作用
- PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节
- 协议字段：
  - 当协议字段为 0x0021 时，PPP 帧的信息字段就是IP 数据报。
  - 若为 0xC021, 则信息字段是 PPP 链路控制数据。
  - 若为 0x8021，则表示这是网络控制数据。

![img](https://img-blog.csdnimg.cn/20200427100318525.png)



透明传输问题：
 有两种方法保证透明传输：**字节填充**和**零比特填充**
 1.**字节填充**
 当信息字段出现和标记字段一样的比特（如0x7E）时，当PPP使用异步传输，它把转义字符定义为0x7D，并使用字节填充，填充方法如下：

1. 信息字段每出现一个0x7E字节转变为2字节序列（0x7D，0x5E）
2. 信息字段出现一个0x7D则转换为2字节序列（0x7D，0x5D）
3. 信息字段出现控制字符，则在字符前加0x7D字节

2.**零比特填充**
 当PPP协议使用异步传输（一连串的比特连续传送）而不是异步传输（逐个字符传送），这时PPP协议采用零比特填充：

- 在发送端，扫描信息字段，发现5个连续的1则填充一个0
- 接收端发现5个连续的1则删除5个1后面的一个0

![img](https://img-blog.csdnimg.cn/20200427101602224.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



PPP 协议之所以**不使用序号和确认机制**是出于以下的考虑：

- 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。

- 在因特网环境下，PPP 的信息字段放入的数据是 IP 数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。

- 帧检验序列 FCS 字段可保证无差错接受

  3. **PPP协议工作状态**

  当用户拨号接入ISP(网络运营商)时，路由器的调制解调器对拨号进行确认，建立物理连接；
   PC机箱路由器发送一些列的LCP(链路控制协议)分组(封装成多个PPP帧)；
   这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP(网络控制协议)给新接入的PC机分配一个临时的IP地址，使PC机成为Internet上的一个主机；
   通信完毕后，NCP释放网络层连接，收回原来分配出去的IP地址；
   接着，LCP释放数据链路层连接；
   最后释放的事物理层连接。

![img](https://img-blog.csdnimg.cn/20200427104337420.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70) 

4. **使用广播信道的数据链路层**（局域网）

   一般是总线型。

   (1)局域网的拓扑

   ![img](https://img-blog.csdnimg.cn/2020010223185676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70)

   (2)共享通信媒体
    静态划分信道(麻烦)：
    频分复用；时分复用；波分复用；码分复用；
    动态媒体接入控制(多点接入)：
    随机接入(主要是以太网)；受控接入，如多点线路探询(polling)，轮询(不采用了)。

   (3)认识以太网
    最初的以太网是将许多计算机都连接到一根总线上，当初认为这样连接即简单又可靠，因为总线上没有有源器件。
    总线上每一个主机都能检测到B发送的数据。但是只有D的地址和数据帧首部写入的地址一致，所以只有D接收。其余计算机都能检测到这不是发送给他们的数据帧，所以就丢弃这个数据帧。
    这是一种具有广播特性的总线上实现了一对一通信。这种方式不安全。

   ![img](https://img-blog.csdnimg.cn/20200102231909360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70)



(4)带冲突检测的载波监听/碰撞检测
 CSMA/CD：
 Carrier Sense Multiple Access with Collision Detection
 多点接入：
 许多计算机以多点接入的方式连接在一根总线上。
 载波监听：
 每一个站在发送数据之前都先要用电子技术检测一下总线时候有其它计算机在发送数据信号，如果有则不发送数据，以免发生碰撞；

(5)碰撞检测
 碰撞检测就是计算机边发送数据边检测信道上信号电压的大小。
 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大；
 当一个站检测到信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站在同时发送数据，表明产生了碰撞；
 碰撞就是冲突，碰撞检测也称冲突检测。
 检测到碰撞后：
 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息；
 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就立即停止发送，避免浪费网络资源，等待一个随机的时间后再次发送。

(6)传播时延对载波监听的影响

![img](https://img-blog.csdnimg.cn/20200102231927199.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2l3YW5kZXJ1,size_16,color_FFFFFF,t_70)

在2t时间内，可能存在碰撞。



(7)CSMA/CD的重要特性
 使用CSMA/CD协议的以太网不能进行全双工通信而只能进行双向交替通信(半双工)；
 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能；
 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。



(8)争用期
 最先发送数据帧的站，在发送数据帧后至多经过时间2t(2倍的端到端往返时延)就可知道发送的数据帧是否发生了碰撞。
 经过争用期这段时间还没有检测到碰撞，就可以肯定不会发生碰撞；
 以太网的争用期：
 ->以太网的端到端往返时延2t称为争用期，或碰撞窗口，通常取51.2微秒为争用期的长度；如果网线过长，会导致争用期时间的延长，这也是为什么网线一般不超过100m；
 ->对于10Mb/s的以太网，在争用期可以发送512bit，也就是64 byte；
 ->以太网在发送数据的时候，若前64字节没有冲突，后续也不会发生冲突；
 最短有效帧长：
 ->如果发生冲突，一定是前64字节；
 ->由于一旦发生冲突就立刻停止，所以已发送的数据一定小雨64字节；
 ->以太网规定了最短有效帧长为64字节，凡事小雨64字节的帧一定是因为冲突而异常终止的无效帧。



(9)二进制指数类型退避算法
 发送碰撞的站在停止发送数据后，要推迟一个随机事件才能发送数据。
 确定基本退避时间，一般是争用期2t；
 定义参数k = min(重传次数，10)；
 从整数集合{0,1,…,2^k-1}中随机取出一个数，记为r，重传所需的时延就是r倍的基本退避时间；
 当重传达16次时仍不能成功时就丢弃该帧，并向高层报告。

​	 <font size=3 color=#00FFFF>**4.1  以太网的MAC地址**</font>

在局域网中，硬件地址又称为物理地址，或 MAC 地址。

48 位的 MAC 地址

- IEEE 的注册管理机构 RA 负责向**厂家分配地址字段的前三个字节**（即高位 24 位)。
- 地址字段中的**后三个字节(即低位 24 位)由厂家自行指派**，称为扩展标识符，必须保证生产出的适配器没有重复地址。

适配器具有**过滤**功能。适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址.

- 如果是发往本站的帧则收下，然后再进行其他的处理。
- 否则就将此帧丢弃，不再进行其他的处理。

“发往本站的帧”包括以下三种帧：

- **单播**(unicast)帧（一对一）
- **广播**(broadcast)帧（一对全体）
- **多播**(multicast)帧（一对多）

**MAC 帧的格式**
 常用的以太网MAC帧格式有两种标准 ：

- DIX Ethernet V2 标准
- IEEE 的 802.3 标准

最常用的 MAC 帧是以太网 V2 的格式。

![img](https://img-blog.csdnimg.cn/20200427164731641.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**无效的 MAC 帧**

- 数据字段的长度与长度字段的值不一致；
- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。（若考虑首尾部，有效的 MAC 帧长度为 64 ~ 1518 字节之间）
- 对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。

**帧间最小间隔**
 帧间最小间隔为 9.6 μs，相当于 96 bit 的发送时间。

- 一个站在检测到总线开始空闲后，还要等待9.6 μs 才能再次发送数据。
- 这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。

#### 3.4  **扩展的以太网**

1. ** 在物理层扩展以太网**

   

   主机使用光纤和一对光纤调制解调器连接到集线器

   ![img](https://img-blog.csdnimg.cn/20200427180956116.png)

   

   用多个集线器可连成更大的局域网

   ![img](https://img-blog.csdnimg.cn/20200427181034752.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

   

   用集线器组成更大的局域网都在一个碰撞域中

   ![img](https://img-blog.csdnimg.cn/20200427181112302.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

    **碰撞域**：在任意时刻，在每个碰撞域只能有一个站在发送数据
    **冲突域**：网络上能够接收到同样广播分组的设备的集合，一个广播域包含一个或多个冲突域
    用集线器扩展局域网：
    **优点**

   - 使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。
   - 扩大了局域网**覆盖的地理范围**。

   **缺点**

   - 碰撞域增大了，但总的**吞吐量并未提高**。
   - 如果不同的碰撞域使用不同的以太网技术（数据率），那么就不能用集线器将它们互连起来。
     2. **在数据链路层扩展以太网**

      最初使用网桥在数据链路层扩展以太网，后来人们广泛使用交换机替代了网桥。

   

   以太网交换机的特点

   以太网交换机实质上是一个多接口的网桥，通常有十几个或更多接口。
    交换机的基本操作：

   - **学习源地址**，构造交换表，每个条目有时间戳，过期删除
   - **过滤**，可以隔离冲突域
   - **选择性转发**，目的地址已知帧单播
   - **泛洪**，目的地址未知帧广播，即将帧发送到除进入接口为的所有接口

   为了避免产生转发的帧在网络中不断地兜圈子，IEEE的802.1D标准制定了**生成树协议STP**，在不改变网络的实际拓扑，在**逻辑上**切断某些链路，使得一台主机到其他主机的路径是无环路的**树状结构**。

   **从总线以太网到星型以太网**：
    不使用CSMA/CD协议，以**全双工方式**工作，但仍然使用**以太网的帧结构**。

   3. **虚拟局域网**

      虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组。这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的**标识符**（tag），指明发送这个帧的工作站是属于哪一个 VLAN。

      ![img](https://img-blog.csdnimg.cn/20200427191056342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

      VLAN间的通信只能通过第三层设备实现：路由器，三层交换机
       VLAN的划分方法：

      1. 基于端口（静态划分）根据端口号划分
      2. 基于MAC地址（动态划分），根据用户计算机的MAC地址划分VLAN
      3. 基于网络地址或网络协议类型（动态），根据用户计算机的IP地址划分VLAN

6. **高速以太网**

速率达到或超过 100 Mb/s 的以太网称为**高速以太网**



***



### 第四章   网络层

#### 4.1  **网络层提供的两种服务**

在计算机通信中，可靠交付应当由**端系统**负责

1. **虚电路服务**

虚电路表示这是一条**逻辑上**的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。电路交换的电话通信是先建立了一条真正的连接。因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

![img](https://img-blog.csdnimg.cn/20200504104649846.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

 

2. 数据报服务

- 网络层向上只提供**简单灵活**的、**无连接**的、尽量**最大努力交付**的数据报服务
- 网络在发送分组时不需要建立连接
- 网络层不通过服务质量的承诺
- 由运输层负责（包括差错处理、流量控制等）

优点：网络造价大大降低，运行方式灵活，能够适应多种应用

![img](https://img-blog.csdnimg.cn/20200504105445898.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/20200504105613860.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



#### 4.2  **网际协议IP**

与IP协议配套使用的还有四个协议：

- 地址解析协议 ARP(Address Resolution Protocol)
- 逆地址解析协议 RARP(Reverse Address Resolution Protocol)
- 网际控制报文协议 ICMP(Internet Control Message Protocol)
- 网际组管理协议 IGMP(Internet Group Management Protocol)

网络层的协议所处的位置：

![img](https://img-blog.csdnimg.cn/20200504110741540.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



##### 	**4.2.1   虚拟互联网络**

网络互联的**中间设备**，或中继系统：

- **物理层**中继系统：**转发器**(repeater)。
- **数据链路层**中继系统：**网桥或桥接器**(bridge)。
- **网络层**中继系统：路由器(router)。
- **网络层以上**的中继系统：**网关**(gateway)

![img](https://img-blog.csdnimg.cn/20200504111407772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



##### 	**4.2.2   分类的IP地址**

IP 地址的编址方法

- **分类的 IP 地址**。这是最基本的编址方法，在 1981 年就通过了相应的标准协议。
- **子网的划分**。这是对最基本的编址方法的改进，其标准[RFC 950]在 1985 年通过。
- **构成超网**。这是比较新的无分类编址方法。1993 年提出后很快就得到推广应用。

分类的IP

每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号** net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是**主机号** host-id，它标志该主机（或路由器）。**一个IP地址在整个互联网范围内是唯一的。**
 两级的 IP 地址可以记为：
 IP 地址 ::= { <网络号>, <主机号>}（::= 代表“定义为”）

![img](https://img-blog.csdnimg.cn/20200504114456193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



A类地址网络号1个字节，主机号3个字节，B类地址网络号2个字节，主机号2个字节，C类地址网络号3个字节，主机号1个字节。

对于第一字节：

- A类地址范围：1~126（网络号以0开头）
- B类地址范围：128~191（网络号以10开头）
- C类地址范围：192~224（网络号以100开头）

A类地址网络号1个字节，主机号3个字节，B类地址网络号2个字节，主机号2个字节，C类地址网络号3个字节，主机号1个字节。

![img](https://img-blog.csdnimg.cn/20200504114841196.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



特殊IP地址：

- 主机号全0：**网络地址**，表示网络本身，具有正常网络号的部分
- 主机号全1：**广播地址**，用于向网络中的所有设备进行广播，具有正常的网络号部分
- 0.0.0.0：表示所有不清楚的主机和目的网络的集合
- 127.0.0.1：**本地环回地址**，该地址是指电脑本身（localhost），主要作用是预留下作为测试使用，用于网络软件测试以及本地机进程间通信
- 1.1.1.1：**有限广播地址**，用于本网广播

注意：
 在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的

##### 	4.2.3 IP地址与硬件地址

IP地址与MAC硬件地址的区别:

![img](https://img-blog.csdnimg.cn/20200508120050482.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



- 在 IP 层抽象的互联网上只能看到 IP 数据报图中的 IP1→IP2 表示从源地址 IP1 到目的地址 IP2两个路由器的 IP 地址并不出现在 IP 数据报的首部中。路由器只根据目的站的 IP 地址的网络号进行路由选择
- 在具体的物理网络的链路层只能看见 MAC 帧而看不见 IP 数据报
- IP层抽象的互联网屏蔽了下层很复杂的细节在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信

![img](https://img-blog.csdnimg.cn/20200508120321198.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

##### 	**4.2.4  地址解析ARP**

![img](https://img-blog.csdnimg.cn/20200508190859619.png)

**地址解析协议 ARP**

- 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须**使用硬件地址**。
- 每一个主机都设有一个 **ARP 高速缓存(ARPcache)**，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。
- 当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机B 的 IP 地址。如有，就可查出其对应的硬件地址，
   再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。

![img](https://img-blog.csdnimg.cn/20200508191148357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

- 从图中我们可以看到，ARP进程在本局域网**广播**发送一个**ARP请求分组**，本局域网的所有主机都会收到请求，当主机的IP地址与ARP请求**一致**时，就会收下这个请求，并向发送方发送**ARP响应分组**，同时将本身MAC地址写入这个ARP响应分组，其他主机IP地址不一致，收到则不理睬这个ARP请求分组。



应当注意：
 ARP 是解决**同一个局域网**上的主机或路由器的 IP 地址和硬件地址的映射问题。
 使用 ARP 的**四种典型情况**

- **发送方是主机**，要把IP数据报发送到**本网络上的另一个主机**。这时用 ARP 找到目的主机的硬件地址。
- **发送方是主机**，要把 IP 数据报发送到**另一个网络上的一个主机**。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。
- **发送方是路由器**，要把 IP 数据报转发到**本网络上的一个主机**。这时用 ARP 找到目的主机的硬件地址。
- **发送方是路由器**，要把 IP 数据报转发到**另一个网络上的一个主机**。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。

#####     **4.2.5  IP数据报的格式**

- 一个 IP 数据报由**首部**和**数据**两部分组成。
- 首部的前一部分是固定长度，共 **20 字节**，是所有 IP 数据报必须具有的。
- 在首部的固定部分的后面是一些可选字段，其长度是可变的。

![img](https://img-blog.csdnimg.cn/20200508193401431.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



IP数据报首部固定部分的各字段

1. **版本**：占4位，指IP协议的版本。

2. **首部长度**：占4位，可表示的最大数值是 15 个单位(一个单位32个字长，为 4 字节)，因此 IP 的首部长度的最大值是 60 字节

3. **区分服务**：占8位，确定优先级，一般不使用

4. **总长度**：占16位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535（2^16-1） 字节。总长度必须不超过最大传送单元 MTU

5. **标识**：占16位，是一个计时器，每产生一个数据报，计时器加一

6. 标志

   ：占3位，目前只有两位有意义

   - 最低标记**MF**，MF=1表示后面还有分片，MF=0表示这是数据报的最后一个
   - **DF**，意思是不能分片，当DF=0才允许分片

7. **片偏移**：占13位， 较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。
    **例**：将长度为3800字节的数据报分片为长度不超过1420字节的数据报片，我们将数据报片分为三部分，分别为1400、1400和1200字节，则它们的片偏移为如下所示：

![img](https://img-blog.csdnimg.cn/20200508194703297.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

8. **生存时间TTL**：占8位，表明数据报在网络的**寿命**，数据报每经过一个路由器，TTL减一，TTL最大为255
    可以通过Ping命令来查看TTL，加上-i选项可以控制TTL大小，从而知道数据报经过的路由器地址。

9. **协议**：占8位，指出数据报携带的数据使用何种协议

10. **首部校验和**：占16位，这个字段只检验数据报的首部，不包括数据部分

![img](https://img-blog.csdnimg.cn/20200508200957825.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

11. **源地址**：占32位

12. **目的地址**：占32位

IP 数据报首部的**可变部分**
 IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。实际上这些选项很少被使用。

#####     4.2.6  IP 层转发分组的流程

假设有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。若按目的主机号来制作路由表，则所得出的路由表就会过于庞大。 但若按主机所在的网络地址来制作路表，那么每一个路由器中的路由表就只包含 4个项目。这样就可使路由表大大简化。



根据目的网络地址就能确定下一跳路由器，这样做的结果是：

- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付。

**默认路由**(default route)

- 路由器还可采用默认路由以**减少路由表所占用的空间和搜索路由表所用的时间**。
- 这种转发方式在一个网络只有**很少的对外连接**时是很有用的。
- 默认路由在主机发送 IP 数据报时往往更能显示出它的好处。
- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和因特网连接，那么在这种情况下使用默认路由是非常合适的

![img](https://img-blog.csdnimg.cn/20200508211335168.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**添加静态路由**
 Windows网关就是默认路由
 查看Windows本地路由表

![img](https://img-blog.csdnimg.cn/2020050820421628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

添加路由表
 三个地址分别是目标IP地址、子网掩码和网关

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200508210411252.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**特别强调**
 IP 数据报的首部中没有地方可以用来指明“下一跳路由器的 IP 地址”。当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件。 网络接口软件使用 ARP 负责将下一跳路由器的IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。

分组转发算法

1. 从数据报的首部**提取目的主机的 IP 地址 D**, 得出目的网络地址为 N。
2. 若网络N 与此路由器直接相连，则把数据报**直接交付**目的主机D；否则是**间接交付**，执行(3)。
3. 若路由表中有**目的地址为 D 的特定主机路由**，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的**下一跳路由器**；否则，执行(5)。
5. 若路由表中有一个**默认路由**，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
6. 报告转发分组**出错**。



#### 		4.3   划分子网与构造超网

##### 	4.3.1  划分子网

早期使用的IP地址空间的**利用率低**，两级IP地址**不够灵活**，因此使用划分子网方式将**两级IP地址**变成**三级IP地址**。

 好处：

- 充分利用地址
- 划分管理职责
- 提高网络性能和安全性

划分子网的思路：

- 划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。
- 从主机号借用**若干个位**作为**子网号** subnet-id，而主机号 host-id 也就相应减少了若干个位。
- 凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的**目的网络号** net-id，先找到连接在本单位网络上的路由器。
- 然后**此路由器**在收到 IP 数据报后，再按目的网络号net-id 和子网号 subnet-id 找到目的子网。
- 最后就将 IP 数据报直接交付目的主机

IP地址 ::= {<网络号>, <子网号>, <主机号>}

子网掩码

使用子网掩码可以找出IP地址中的子网划分

![img](https://img-blog.csdnimg.cn/20200504161501649.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



将子网掩码与IP地址进行逐位与运算，可得到其网络地址
 例如：已知 IP 地址是 141.14.72.24，子网掩码是 255.255.192.0。试求网络地址？

![img](https://img-blog.csdnimg.cn/20200504161831175.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

默认的子网掩码

![img](https://img-blog.csdnimg.cn/20200504162106447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

子网掩码是一个网络或一个子网的重要属性，划分子网增加了灵活性，但却减少了能够连接在网络上的主机数。



##### 	4.3.2   使用子网时分组的转发

使用子网划分后，路由器必须包括以下三项内容：**目的网络地址**、**子网掩码**和**下一跳地址**。
 路由器转发分组算法：

1. 从收到的分组的首部提取目的 IP 地址 D。
2. 先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。
3. 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行(4)。
4. 对路由表中的每一行的子网掩码和 D 逐位相“与”，若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行(5)。
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行(6)。
6. 报告转发分组出错



##### 	4.3.3  无分类编址CIDR（构造超网）

网络前缀

划分子网在一定程度上缓解了因特网在发展中遇到的困难。然而在1992 年因特网仍然面临三个必须尽早解决的问题，这就是：

- B 类地址在 1992 年已分配了近一半，眼看就要在 1994 年 3 月全部分配完毕！
- 因特网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）。
- 整个 IPv4 的地址空间最终将全部耗尽。

IP 编址问题的演进
 一开始使用变 长 子 网 掩 码VLSM(Variable Length Subnet Mask)，后来在 **VLSM** 的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择 **CIDR** (Classless Inter-DomainRouting)。
 **CIDR特点**：

- CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。
- CIDR 使 用 各 种 长 度 的 “ 网 络 前缀”(network-prefix)来代替分类地址中的网络号和子网号。
- IP 地址从三级编址（使用子网掩码）又回到了两级编址。

####     4.4 网际控制报文协议ICMP

为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。ICMP 不是高层协议，而是 IP 层的协议。

ICMP报文种类

ICMP报文有两种，**ICMP差错报告报文**和**ICMP询问报文**
 ICMP报文前四个字节是统一的格式，共三个字段：**类型**、**代码**和**检验和**

![img](https://img-blog.csdnimg.cn/20200511113402114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

ICMP 差错报告报文共有 4 种

- **终点不可达**：当路由器或主机不能交付数据报
- **时间超过**：当路由器收到生存时间为零的数据报或终点在预定时间不能收到一个数据报的全部数据
- **参数问题**:当路由器或目的主机收到数据报首部有字段的值不正确
- **改变路由（重定向）**(Redirect)：路由器吧改变路由的报文发送给主机，让下次主机选择另外更好地路由。

**ICMP 差错报告报文的数据字段的内容**
 将IP数据报首部和数据字段前8个字节提取出来（这8个字节是为了对应得到上层协议端口与发送序号），作为ICMP的数据字段在加上ICMP差错报告报文前8个字节，就构成了ICMP差错报告报文。

![img](https://img-blog.csdnimg.cn/20200511114457394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**ICMP 询问报文**有两种

- 回送请求和回答报文
- 时间戳请求和回答报文

应用举例

通过ICMP可以探测网络故障

1. Ping命令
    PING 用来测试两个主机之间的连通性。PING 使用了 **ICMP 回送请求与回送回答报文**。PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。
2. tracert和pathping命令
    这两个命令都可跟踪数据包从源点到终点的路径，pathping还能看到路径上某个结点的丢包率，在这里*表示该结点路由器被设置为不可访问

####     4.5 互联网的路由选择协议

#####     4.5.1 关于选择协议的几个基本概念

1.理想的路由选择

1. 完整与正确
2. 计算简单
3. 能适应通信量与网络拓扑的变化，有自适应性（稳健性）
4. 具有稳定性
5. 应是最佳的，相对于某种特定需求下较为合理的选择

从路由算法的自适应性考虑分两大类：

- 静态路由选择策略（非自适应路由选择）：简单，开销小，但不能适应网络状态的变化
- 动态路由选择策略（自适应路由选择）：能较好适应网络状态的变化，但实现较为复杂，开销大

2.分层次的路由选择协议

将互联网划分为许多小的自治系统，记为AS，一个AS对其他AS表现出**单一的和一致的路由选择策略**。
 互联网把路由选择协议划分为两大类：

1. **内部网关协议IGP**：自治系统内部使用的路由选择协议，如**RIP和OSPF**
2. **外部网关协议EGP**：当源主机与目的主机处在不同的自治系统中所使用的路由选择协议，目前使用最多的是**BGP-4**

 自治系统之间的路由选择也叫做**域间路由选择**(interdomain routing)，
 在自治系统内部的路由选择叫做**域内路由选择**(intradomain routing)

![img](https://img-blog.csdnimg.cn/20200511145834860.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

#####     4.5.2  内部网关协议RIP

RIP是一种分布式的基于距离向量的路由选择协议，网关就是默认路由
 **“距离”的定义**：

- 从一路由器到直接连接的网络的距离定义为 1。从一个路由器到非直接连接的网络的距离定义为**所经过的路由器数加 1**。
- RIP 协 议 中 的 **“ 距 离 ” 也 称 为 “ 跳数”(hop count)**，因为每经过一个路由器，跳数就加 1。
- RIP 允许一条路径最多只能包含 15 个路由器。**“距离”的最大值为16 时即相当于不可达**。可见 RIP 只适用于小型互联网。

**RIP协议缺点**：
 RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。
 RIP 协议的**三个要点**：

- 仅和**相邻路由器**交换信息。
- 交换的信息是**当前本路由器所知道的全部信息**，即自己的路由表。
- **按固定的时间间隔交换路由信息**，例如，**每隔 30 秒**。

```java
路由选择算法
已知地址为X的相邻路由器发来RIP报文，先将收到的报文下一跳该为X，
所有距离加1，再对该表与自身路由表逐条进行比较。
if（原路由表无目的网络N）{
	将该项目添加到路由表中}
if else（本机路由表下一跳为X）{
	将该条更新原本的项目}
if else（距离<原来）{
	更新该条到路由表}
else{
	不做更新操作}
if（三分钟收不到更新路由表）{
	将此相邻路由表距离设置为16（不可达）}
```

分析：
 本路由器与相邻路由器相距为1，通过相邻路由表可知，本路由器经过相邻路由器到达目的地址的距离会加1，所以d+1，下一跳设置为X。然后对路由表进行比较，目的地址未知则直接添加，目的地址已知，看本路由表下一跳是否为X，如果是，则更新，因为这是最新消息。如果不是，比较距离，距离比原来小可添加。如果长时间收不到更新路由表，则自动标记为不可达。

**RIP2 协议的报文格式**

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200511153845512.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

RIP 协议的优缺点

- RIP 存在的一个问题是当网络出现故障时，要经过**比较长的时间**才能将此信息传送到所有的路由器。
- RIP 协议最大的优点就是**实现简单，开销较小**。
- RIP 限制了网络的规模，它能使用的**最大距离为 15**（16 表示不可达）。

#####     4.5.3 内部网关协议OSPF

**开放的最短路径优先**OSPF，主要特征是使用分布式的**链路状态协议**。
 要点：

1. 使用**泛洪法**，向本自治系统所有·路由器发送信息
2. 发送的是有本路由器**相邻的所有路由器的链路状态**
3. 只有**链路状态改变**时才使用泛洪发送信息

OSPF 将一个自治系统再划分为若干个更小的范围，叫作**区域**。区域也不能太大，在一个区域内的路由器最好**不超过 200 个**。

![img](https://img-blog.csdnimg.cn/20200511222516348.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

OSPF 使用层次结构的区域划分（仅有两层）。在上层的区域叫作**主干区域**(backbone area)。主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域将自治系统划分为多个区域，这样做可使泛洪法交换链路信息时只局限于一个区域，而不用扩大到整个自治系统，而一个区域的路由器只知道本区域的拓扑结构。

OSPF建立网络拓扑结构图的方式：

1. 首先每个路由器会每10s对相邻的路由器**发送问候（Hello）分组**，来维持相邻路由器的可达性。
2. 通过交换得到的链路状态信息，建立**链路状态数据库**，构造全网的拓扑结构图。
3. 当链路状态发生改变时，每个路由器都能及时**更新同步数据库**。

#####     4.5.4 外部网关协议BGP

边界网关协议 BGP 只能是力求寻找一条能够**到达目的网络且比较好的路由**（不能兜圈子），而并非要寻找一条最佳路由。每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ **BGP 发言人**” ，一般为BGP边界路由器。

![img](https://img-blog.csdnimg.cn/20200511230150639.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

通过BGP协议可将上图的网络看做是如下形式：

![img](https://img-blog.csdnimg.cn/2020051123022817.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

进而实现多级ISP的网络多级结构

![img](https://img-blog.csdnimg.cn/20200511230620762.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

#### 	4.6   IPv6

目的：从根本上解决地址耗尽的问题

##### 	  4.6.1  IPv6的基本首部

IPv6的主要变化：

1. **更大的地址空间**：从32位（4B）增大到128位（32B）
2. **扩展的地址层次结构**：IPv6由于地址空间很大，可划分更多层次
3. **灵活的首部格式**：定义了许多可选的扩展首部
4. **改进的选项**
5. **允许协议继续扩充**
6. 支持**即插即用**，自动配置：不需要使用DHCP
7. 支持**资源的预分配**
8. 首部**8字节对齐**
9. IPv6只能在**主机处分片**，IPv4能在路由器和主机处分片
10. **ICMPv6**：附加报文类型“分组过大”

![img](https://img-blog.csdnimg.cn/20200514193521199.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

IPv6数据报格式

![img](https://img-blog.csdnimg.cn/20200514194040616.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

- **版本**：占4位，指明了版本协议，总是6

- **优先级**：占8位，区分数据报的类别和优先级

- **流标签**：占20位，“流”是从特定源点到特定终点的一系列数据报，所有属于同一个流的数据报有同样的流标签。

- **有效载荷长度**：占16位，它指明IPv6数据报除基本首部以外的字节数，这个字段最大64KB

- 下一个首部

  ：占8位

  - 当IPv6没有扩展首部时，它的作用相当于协议字段，指明数据报一个交付上层那个协议
  - 当出现扩展首部，它就用来标识后面一个扩展首部的类型

- **跳数限制**：占8位，相当于IPv4的TTL（生存时间）

- **源地址**：占128位，是数据报发送端IP地址

- **目的地址**：占128位，是数据报接收端IP地址

#####       4.6.2   IPv6的地址

**IPv6地址表示形式**

![img](https://img-blog.csdnimg.cn/20200514201039942.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

IPv6基本地址类型

- **单播**：一对一通信，可做源地址或目的地址
- **多播**：一对多通信，只能用于目的地址
- **任播**：IPv6新增类型，可做目的地址，通常是距离最近的一个发送数据报

#####       4.6.3  从IPv6向Ipv4过渡

1. **双栈协议**
    双协议栈技术就是指在一台设备上**同时启用IPv4协议栈和IPv6协议栈**。这样的话，这台设备既能和IPv4网络通信，又能和IPv6网络通信。如果这台设备是一个**路由器**，那么这台路由器的不同接口上，**分别配置了lPv4地址和IPv6地址**，并很可能分别连接了IPv4网络和IPv6网络。如果这台设备是一个**计算机**，那么它将**同时拥有IPv4地址和IPv6地址**，并具备同时处理这两个协议地址的功能。
2. **隧道技术**
    通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据（或负载可以是不同协议的数据帧或包。隧道协议将**其它协议的数据帧或包重新封装**然后通过隧道发送。



#### 	4.7 VPN技术和网络地址转换

- 本地地址——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向因特网的管理机构申请。
- 全球地址——全球唯一的IP地址，必须向因特网的管理机构申请

![img](https://img-blog.csdnimg.cn/20200514210947672.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

A与B内部的通信本来不经过互联网，如果两者之间想要通信，可使用VPN技术，A将数据报作为内部数据发给路由器R1，路由器R1收到数据报后，对内部数据报加密（保证数据安全），然后重新加上数据报的首部，封装成互联网的外部数据报，到达R2，然后在进行解密，从而实现两者间的通信。

<font color=#00ffffff>网络地址转换NAT</font>

NAT原理：
 内部主机 X 用本地地址 IPX 和因特网上主机 Y 通信所发送的数据报必须经过 NAT 路由器。NAT 路由器将**数据报的源地址 IPX 转换成全球地址 IPG**，但目的地址 IPY 保持不变，然后发送到因特网。NAT 路由器收到主机 Y 发回的数据报时，知道数据报中的源地址是 IPY 而目的地址是 IPG。根据 NAT 转换表，NAT 路由器将目的地址 IPG转换为 IPX，转发给最终的内部主机 X。

现常用的NAT转换表利用**运输层的端口号**，使得多个拥有本地地址的主机共用一个路由器上的全球IP地址，使用端口号的NAT也叫网络地址与端口号转换NAPT。



使用**netstat -n** 可查看建立会话的目**标端口**和**源端口**

![img](https://img-blog.csdnimg.cn/2020051421201415.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



***



### 第五章  传输层

#### **5.1 运输层协议概述**

- 运输层向上面的应用层提供通信服务，它属于面向通信部分的最高层，也用户功能的最低层。
- 只有**主机的协议栈有运输层**，路由器**转发分组只用到下三层**
- 从IP层来说，通信的两段是**两台主机**
- 从运输层的角度看，通信的**真正端点是主机的进程**

![img](https://img-blog.csdnimg.cn/20200521195344542.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

应用进程之间的通信：

- 两个主机进行通信实际上就是两个主机中的**应用进程互相通信**。

- 应用进程之间的通信，又称**端到端的通信**

- 运输层一个很重要的功能就是

  复用

  和

  分用

  - 复用：发送方不同的应用进程同时使用同一个运输层协议传输数据
  - 分用：接收方运输层剥去报文首部能正确的交付目的进程

- 运输层提供应用进程间的**逻辑通信** （如下图所示）

![img](https://img-blog.csdnimg.cn/20200521193042583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



TCP/IP 的运输层有两个不同的协议：

1. 用户数据报协议 UDP(User Datagram Protocol)
2. 传输控制协议 TCP(Transmission Control Protocol)

![img](https://img-blog.csdnimg.cn/20200521210527558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



**常用的熟知端口号**

|  应用程序  | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP | HTTPS | SNMP(trap) |
| :--------: | :--: | :----: | :--: | :--: | :--: | :--: | :--: | :---: | :--------: |
| 熟知端口号 |  21  |   23   |  25  |  53  |  69  |  80  | 161  |  443  |    162     |

#### 5.2 用户数据报协议UDP

##### 5.2.1 UDP概述

用户数据报协议UDP只在IP数据报服务之上增加了复用和分用（也就是端口功能）及差错检验功能。

![img](https://img-blog.csdnimg.cn/2020052121493676.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



**特点**：

1. UDP是无连接的
2. UDP使用尽最大努力交付，即不保证可靠交付
3. UDP是面向报文的，将应用层交下来的报文照样发送，也就是一次交付一个完整的报文
4. UDP没有拥塞控制
5. UDP支持一对一，一对多，多对一和多对多的交互通信
6. UDP首部开销小

![img](https://img-blog.csdnimg.cn/2020052121454490.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

##### 5.2.2 UDP的首部格式

用户数据报 UDP 有两个字段：数据字段和首部字段。首部字段有 **8 个字节**，由 4 个字段组成，每个字段都是两个字节。

1. 源端口
2. 目的端口
3. 长度
4. 校验和

UDP用户数据报之前增加**12字节**的**伪首部**，在计算检验和时，临时把“伪首部”和 UDP 用户数据报连接在一起。伪首部仅仅是为了计算检验和。

![img](https://img-blog.csdnimg.cn/2020052121490522.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

#### 5.3 传输控协议TCP概述

##### 5.3.1 TCP的主要特点

1. TCP是**面向连接**的运输层协议
2. 每一条 TCP 连接只能有**两个端点**(endpoint)，每一条 TCP 连接只能是**点对点**的（一对一）。
3. TCP 提供**可靠交付**的服务。
4. TCP 提供**全双工通信**。
5. **面向字节流**。

TCP与应用程序的交互是**一次一个数据块**（大小不定），TCP将应用程序交下来的数据看成是一连串的**无结构的字节流**，并且TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系，但是接收方应用程序收到的字节流**必须与发送的一致**。也就是过程中的数据分块可以多样，但是最终的结果是传输数据完整一致。

![img](https://img-blog.csdnimg.cn/20200522195324954.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



**注意**：

- TCP 连接是一条**虚连接**而不是一条真正的物理连接。
- TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是**不关心**的。
- TCP 根据对方给出的**窗口值和当前网络拥塞**的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。
- TCP 可把太长的数据块划分短一些再传送。TCP也可等待积累有足够多的字节后再构成报文段发送出去。

##### 5.3.2 TCP 的连接

TCP 把连接作为**最基本的抽象**，每一条 TCP 连接有**两个端点**。TCP 连接的端点叫做**套接字(socket)或插口**。

端口号**拼接**到(contatenated with) IP 地址即构成了套接字。每一条 TCP 连接**唯一地被通信两端的两个端点**（即两个套接字）所确定。
 **套接字 (socket)**：

![img](https://img-blog.csdnimg.cn/20200522200005235.png)

![img](https://img-blog.csdnimg.cn/20200522200051626.png)

#### 5.4 可靠传输的工作原理

##### 5.4.1 停止等待协议

在全双工通信时双方既是发送方也是接收方，这里我们仅考虑A发送数据B接收数据，因此A为**发送方**，B为**接收方**。

**无差错情况**
 A向B发送M1，发送完停止发送，B收到M1就向A发送确认，A收到确认继续发送M2，同样收到B的确认后发送M3，如此往复。
 **出现差错**
 当A发送M1之后，B收到M1后检验出现错误而丢弃了M1（但是没有通知A收到有差错数据），A超过一段时间没有收到确认，就会重新传M1，这就是**超时重传**，实现超时重传用到了超时计时器。

![img](https://img-blog.csdnimg.cn/20200522203234298.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

注意：

1. A发送完分组后，必须**暂时保留**已发送分组的副本
2. 分组和确认分组应**进行编号**
3. 超时计时器应该**比平均往返时间长一些**

**确认丢失**
 当B向A发送的对M1的确认丢失了，A在超时计时器到期后未收到M1的确认，于是A会重传M1，此时B收到M1后，会丢弃重复的这个M1，然后再次向A发送M1的确认。
 **确认迟到**
 同样B收到M1后发送M1的确认，但是M1因为网络等等原因并未及时被A收到，这时A有重传了M1，B收到后同样是丢弃重复的M1并再次发送M1的确认。

![img](https://img-blog.csdnimg.cn/20200522204253284.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



使用上述的确认和重传机制，我们就可以**在不可靠的传输网络上实现可靠的通信。\**这种可靠传输协议常称为\**自动重传请求ARQ** (Automatic Repeat reQuest)。ARQ 表明重传的请求是**自动**进行的。接收方不需要请求发送方重传某个出错的分组 。

**信道利用率**

停止等待协议的优点是简单，但缺点是信道利用率太低。

![img](https://img-blog.csdnimg.cn/20200522204602250.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**信道利用率计算式：**

![img](https://img-blog.csdnimg.cn/20200522204633250.png)

为了提高传输效率，可以采用**流水线传输**:
 发送方可连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认。由于信道上一直有数据不间断地传送，这种传输方式可获得很高的信道利用率。

![img](https://img-blog.csdnimg.cn/20200522204832945.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

##### 5.4.2 连续ARQ协议

> ARQ协议，即自动重传请求（Automatic Repeat-reQuest），是OSI模型中数据链路层和传输层的错误纠正协议之一。它通过使用**确认**和**超时**这两个机制，在不可靠服务的基础上实现可靠的信息传输。如果发送方在发送后一段时间之内没有收到确认帧，它通常会重新发送。ARQ包括停止等待ARQ协议和连续ARQ协议，拥有错误检测（Error Detection）、正面确认（Positive Acknowledgment）、超时重传（Retransmission after Timeout）和 负面确认及重传（Negative Acknowledgment and Retransmission）等机制。

设置一个发送窗口，实质就是一个数字，如下图的连续将五个分组发送出去而不等待对方确认，当发送方每接收一个确认，发送窗口就向前滑动一个分组的位置。

![img](https://img-blog.csdnimg.cn/2020052220565255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)



回退n帧（go-back-n）ARQ

**回退n帧ARQ**可以看做是发送窗口 > 1 ，接收窗口 = 1的滑动窗口协议，这就是说接收方不必对收到的分组逐个发送确认，而是在收到几个分组后，**对按序到达的最后一个分组发送确认**，这就表示：到这个分组为止的所有分组都已正确收到了。

但网络状况不好的时候会出现，如发送窗口为 10 时，一次发送 10 个数据包，前面两个正确返回了，但第三个丢失了，这时发送方就得重新从第三个包开始，把后面的再传一遍，接收方也必须抛弃前面的 4 - 10 这几个帧，所以网络不佳的情况下可能会比停止等待ARQ还慢。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9nc3MwLmJkc3RhdGljLmNvbS85NG8zZFNhZ194STRraEdrcG9XSzFIRjZoaHkvYmFpa2UvYzAlM0RiYWlrZTcyJTJDNSUyQzUlMkM3MiUyQzI0L3NpZ249ZWNiNDhjZWYxNDk1MGE3YjYxMzg0Njk2NmJiODA5YmMvZTRkZGU3MTE5MGVmNzZjNjA3NTMyY2YyOTQxNmZkZmFhZTUxNjc2Mi5qcGc)

**选择重传（selective repeat）ARQ**

**回退n帧ARQ**在出现错误帧时，发送方要把**错误帧之后的所以帧重发一遍**，在网络情况不佳的时候只会**进一步恶化网络**。

选择重传ARQ可以看做是发送窗口 > 1 ，接收窗口 > 1的滑动窗口协议，其会在接收端缓存所有收到的帧，当某个帧出现错误则只需要重传这个错误的帧即可，只有当收到的帧序号都正确了才会往高层应用传递。

选择重传ARQ的缺点是相较于回退n帧ARQ，其在服务端需要更多的缓存。



**累积确认**：
 接收方通常采用累积确认的方式，收到几个分组后将**最后一个分组发送确认**，表示这个分组之前的所有分组都已确认。
 **优点**：容易实现，即使确认丢失也不必重传。
 **缺点**：不能向发送方反映出接收方已经正确收到的所有分组的信息。

TCP 可靠通信的具体实现

- TCP 连接的每一端都必须设有两个窗口——一个**发送窗口**和一个**接收窗口**。
- TCP 的可靠传输机制用**字节的序号**进行控制。TCP 所有的确认都是**基于序号**而不是基于报文段。
- TCP 两端的四个窗口经常处于**动态变化**之中。
- TCP连接的往返时间 RTT 也**不是固定不变**的。需要使用特定的算法估算较为合理的重传时间。

#### 5.5 TCP报文段的首部格式

TCP首部前20个字节是固定的，后面为可选字段，因此TCP首部**最小长度20字节**。

![img](https://img-blog.csdnimg.cn/20200522220937677.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

首部固定字段意义：

- **源端口和目的端口**：各占2字节，分别写入源端口和目的端口号，从而通过实现分用
- **序号**：占4个字节，表示携带的数据报首个字节的序号，因此总感觉字段也称为“报文段序号”
- **确认号**：占4个字节，是期望对方下一个报文段的第一个数据字节序号，若确认号=N，则表明到序号N-1为止的所有数据都已正确收到
- **数据偏移**：占4位，表明TCP数据起始处位置，数据偏移单位为32位（4个字节），因此TCP首部最大长度不超过60字节（4*2^4）
- **保留**：占6位
- 6个控制位
  - **紧急URG**：当URG=1，表明紧急指针字段有效，URG字段可使报文段在发送方传输时进行加急插队
  - **推送PSH**：发送方将PSH置1，接收方收到PSH=1的报文段，会尽快交付到应用程序，也就是在接收方进行加急插队
  - **确认ACK**：仅当ACK=1时确认号字段才有效，TCP规定在建立连接后所有传送的报文段都必须将ACK置1
  - **同步SYN**，在建立连接时用来同步序号，SYN = 1 表示这是一个连接请求或连接接受报文
  - **复位RST**：当 RST = 1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。
  - **终止FIN**：用来释放一个连接。FIN = 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接
- **窗口**：占2个字节，用来让对方设置发送窗口的依据。窗口字段指明选择允许对方发送的数据量
- **校验和**：占2个字节，检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部
- **紧急指针**：占2个字节，只有URG=1紧急指针才有意义，它支持本报文段中紧急数据的字节数
- **选项**：长度可变，最长可达40字节，TCP最初只规定了一种选项MSS表示报文段的数据字段的最大长度（数据字段+TCP首部=TCP报文段）

#### 5.6 TCP可靠传输的实现

为方便讨论，这里我们**假定数据传输只在一个方向**进行（实际一般都是双向进行的）

##### 5.6.1 以字节为单位的滑动窗口

假设A收到B发送的确认报文段，得知B的接收窗口是20，确认号是31，于是A就将发送窗口设为20，然后向B发送31以后的大小不定的报文段，直到发送窗口的字节发送完毕，B收到A发送的报文段，累积一定的字节（假设为10字节）就会发送确认信息并加上确认号41，发送完确认信息软件就能从接收缓存读取接收的报文段，并且接收窗口会往后移动，A收到确认信息同样发送窗口也会往后移动。

![img](https://img-blog.csdnimg.cn/20200523203309397.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**A 收到新的确认号，发送窗口向前滑动**：

![img](https://img-blog.csdnimg.cn/20200523203330670.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

A 的发送窗口内的序号都已用完，但还**没有再收到确认**，**必须停止发送**。

![img](https://img-blog.csdnimg.cn/20200523203502817.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**发送缓存与接收缓存的作用**

**发送缓存**用来暂时存放：

- 发送应用程序传送给发送方 TCP 准备发送的数据；
- TCP 已发送出但尚未收到确认的数据。

**接收缓存**用来暂时存放：

- 按序到达的、但尚未被接收应用程序读取的数据；
- 不按序到达的数据。

##### 5.6.2超时重传的选择

重传机制是 TCP 中**最重要和最复杂**的问题之一。TCP 每发送一个报文段，就对这个报文段设置一次计时器。只要计时器设置的重传时间到但还没有收到确认，就要重传这一报文段。

**加权平均往返时间**
 TCP 保留了 RTT 的一个**加权平均往返时间** RTTS（这又称为**平滑的往返时间**）。第一次测量到 RTT 样本时，RTTS 值就取为所测量到的 RTT 样本值。以后每测量到一个新的 RTT 样本，就按下式重新计算一次 RTTS：

> **新的 RTTS = (1 − α) x (旧的 RTTS)  + α x (新的 RTT 样本)**

0< α < 1。若 α 很接近于零，表示 RTT 值更新较慢。若选择 α 接近于 1，表示 RTT 值更新较快。RFC 2988 推荐的 **α 值为 1/8**，即 0.125。

选择确认SACK

当收到的报文段无差错，只是未按序号，就可以采用确认选择作为一种处理方法：

![img](https://img-blog.csdnimg.cn/20200523204616109.png)

如图所示前面是连续的字节流，但是出现了两个字节块并未按顺序接收到，这里就使用了指针进行标记边界，**L表示左边界，也就是字节块第一个字节**，**R表示右边界，这里说明是字节块最后一个字节的后一位**。通过这两个指针就可以将信息发送给发送方，说明已经接受到了这个字节块。

#### 5.7 **TCP的流量控制**

**流量控制**(flow control)就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞。利用**滑动窗口机制**可以很方便地在 TCP连接上实现流量控制。
 通过滑动窗口机制可以动态调整双方的发送与接收窗口，从而不至于一次性发送大量数据而导致接收方处理不过来。

A与B建立连接，B告诉A它的接收窗口rwnd是400字节

![img](https://img-blog.csdnimg.cn/20200523211414610.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

发送方一直等待接收方的确认信息，但是确认报文段可能中通丢失，这样A一直等待B的确认，B一直等待A发送数据，产生相互等待的死锁。为了解决这个问题
 TCP 为每一个连接设有一个**持续计时器**，只要 TCP 连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个**零窗口探测报文段**（仅携带 1 字节的数据），而对方就在确认这个探测报文段时给出了现在的窗口值。若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器。 若窗口不是零，则死锁的僵局就可以打破了。

#### 5.8 TCP的拥塞控制

##### 5.8.1 拥塞控制的一般原理

在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏——产生**拥塞**(congestion)

**出现资源拥塞的条件**：
 对资源需求的总和 > 可用资源

**拥塞控制与流量控制的关系**：

- 拥塞控制就是防止过多的数据注入到网络中，使网络中的路由器或链路不至于过载
- 流量控制是指点对点通信量的控制，是端到端的问题

![img](https://img-blog.csdnimg.cn/20200523224351913.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

##### 5.8.2 TCP的拥塞控制方法

**TCP拥塞控制算法有四种：**

1. 慢开始
2. 拥塞避免
3. 快重传
4. 快恢复

**慢开始和拥塞避免**

拥塞控制也叫做**基于窗口**的拥塞控制，发送方维持一个叫做**拥塞窗口 cwnd** (congestionwindow)的状态变量。
 **慢开始算法的原理**：增大发送端的拥塞窗口cwnd，可以使分组注入到网络的速率更加合理。使用慢开始算法后，每经过一个传输轮次，拥塞窗口cwnd就加倍。

![img](https://img-blog.csdnimg.cn/20200523225440409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

为了防止拥塞窗口cwnd增长过大引起网络拥塞，需要设置一个慢开始门限ssthresh状态变量，慢开始用法如下：

- 当 cwnd < ssthresh 时，使用慢开始算法。
- 当 **cwnd > ssthresh** 时，停止使用慢开始算法而改用拥塞避免算法。
- 当 cwnd = ssthresh 时，既可使用慢开始算法，也可使用拥塞避免算法。
- 拥塞避免算法的思路是让拥塞窗口 cwnd **缓慢地增大**，即每经过一个往返时间 RTT 就把发送方的拥塞窗口**cwnd 加 1**，而不是加倍，使拥塞窗口 cwnd 按**线性规律缓慢增长**。

![img](https://img-blog.csdnimg.cn/20200523225848104.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**乘法减小(multiplicative decrease)**
 “乘法减小“是指不论在慢开始阶段还是拥塞避免阶段，只要出现一次超时（即出现一 次 网 络 拥 塞 ） ， 就 把 慢 开 始 门 限 值ssthresh 设置为当前的拥塞窗口值乘以0.5。当网络频繁出现拥塞时，ssthresh 值就下降得很快，以大大减少注入到网络中的分组数。
 **加法增大(additive increase)**
 “加法增大”是指执行拥塞避免算法后，在收到对所有报文段的确认后（即经过一个往返时间），就把拥塞窗口 cwnd增加一个MSS 大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞。

**快重传和快恢复**

**快重传算法**首先要求接收方每收到一个失序的报文段后就立即发出重复确认。这样做可以让发送方及早知道有报文段没有到达接收方。发送方只要一连收到**三个重复确认**就应当立即重传对方尚未收到的报文段

![img](https://img-blog.csdnimg.cn/20200523230540359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**快恢复算法**
 (1) 当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，把慢开始门限 ssthresh减半。但接下去**不执行慢开始算法**。
 (2)由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，即拥塞窗口cwnd 现在不设置为 1，而是**设置为慢开始门限 ssthresh 减半后的数值**，然后开始执行拥塞避免算法（“加法增大”），使拥塞窗口缓慢地线性增大。

![img](https://img-blog.csdnimg.cn/20200523230716700.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**发送窗口的上限值**
 发送方的发送窗口的上限值应当取为**接收方窗口rwnd** 和**拥塞窗口 cwnd** 这两个变量中较小的一个，即应按以下公式确定：

> 发送窗口的上限值 = Min [rwnd, cwnd]

#### 5.9 TCP的运输连接管理

**运输连接有三个阶段**：

- 连接建立
- 数据传输
- 连接释放

TCP 连接的建立都是采用**客户服务器方式**。主动发起连接建立的应用进程叫做**客户**(client)。被动等待连接建立的应用进程叫做**服务器**(server)。

**5.9.1 TCP的连接建立（三次握手）**

TCP建立连接的过程叫**握手**，握手需要客户与服务器之间交换**三个TCP报文段**。

下面是三次握手的内容（**ACK：确认位，SYN：同步位，seq：序号，表示报文段数据的第一个字节，ack：确认号，表示希望收到对方下一个报文段的第一个数据字节序号**）

- 客户机A 的 TCP 向 B 发出**连接请求报文段**，其首部中的同步位 **SYN = 1**，并选择序号 **seq = x**，表明传送数据时的第一个数据字节的序号是 x。（此时主机A处于**SYN-SENT状态**）
- 服务器B的TCP收到报文请求后，如果同意建立连接，就会发送确认报文，报文内容为**SYN = 1**，使 **ACK = 1**，确认号**ack = x + 1**，自己选择的序号 **seq = y**。（此时主机B处于**SYN-RCVD状态**）
- A收到B的确认报文后，向B发送确认报文，此时ACK=1，seq=x+1，ack=y+1，同时A的TCP通知上层应用连接已经建立（此时A处于**ESTABLISHED状态**）
- B收到确认报文同样通知上层应用：TCP建立已经连接（B也处于**ESTABLISHED状态**）

![img](https://img-blog.csdnimg.cn/20200524095942417.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

注意事项：

- 一开始双方都处于**CLOSED**（关闭）状态，本例中A主动打开连接，B被动打开连接，双方都首先要创建**TCB传输控制模块**，然后B将处于**LISTEN**监听状态（使用**80端口**）
- 前两次握手**SYN位都置1**，而**ACK位三次都置1**，前两次都是**SYN同步报文段**，所以后面的seq序号都只+1，第三次握手如果不携带数据，下一个数据报文段序号仍然为seq=x+1



**为什么前两次已经建立连接，仍然需要第三次握手？**
 假定出现这种情况：A发送了第一个请求连接，请求报文段并未丢失，而是在网络中滞留了一段时间，A因为没收到确认报文，于是重传了一次连接请求，然后与B正常建立了连接，这时B收到了A第一次发送的请求报文因为A又发了一次新的连接请求，于是向A发送确认报文段，同意建立连接。假如没有第三次握手，B发出确认后，连接已经建立。但是A并未请求新的连接，于是会丢弃B的确认报文，而B因为新的连接已经建立，一直等待A发送数据，这样就造成B的许多资源浪费。



**5.9.2 TCP的连接释放（四次挥手）**

传输结束后，双方可释放连接，选择A和B都处于ESTABLSHED状态（**终止位FIN**同样不携带数据，但是要消耗一个序号）

下面是四次挥手过程：

- A数据传输完成，发送连接释放报文，将**FIN=1，seq=u**等待B的确认（此时A处于**FIN-EAIT-1状态**）
- B收到释放连接报文段后发出确认，**ACK=1，seq=v，ack=u+1**，TCP服务器进程会通知高层应用，TCP连接处于**半关闭状态**，只有B还能向A发送数据（此时B进入**CLOSE-WAIT状态**）
- A收到B的确认，进入**FIN-WAIT2**状态，等待B的连接释放报文
- 当B没有数据向A发送时，应用进程会通知TCP释放连接，B发送释放连接报文，FIN=1，seq=w，ack=u+1，然后等待A的确认（B进入**LAST-ACK最后确认状态**）
- A收到B的连接释放报文段后，必须发送确认，将**ACK置1，确认号ack=w+1，seq=u+1**，然后进入TIME-WAIT状态，但是现在TCP连接还没释放，只有**等待2MSL**（每个MSL为2分钟）后，A才进入CLOSED状态
- B收到A的确认则立即进入CLOSED状态

> MSL叫做**最长报文段寿命（Maximum Segment Lifetime）**，建议时间为2分钟，也可以使用更小的值

![img](https://img-blog.csdn.net/20150423101658523)



**为什么A进入TIME-WAIT必须等待 2MSL 的时间？**

1. 为了保证 A 发送的最后一个 **ACK 报文段能够到达 B**。
2. 防止 **已失效的连接请求报文段**出现在本连接中。A 在发送完最后一个 ACK 报文段后，再经过时间 2MSL，就可以使本连接持续的时间内所产生的所有报文段，都从网络中消失。这样就可以使下一个新的连接中不会出现这种旧的连接请求报文段。

***



### 第六章   应用层

应用层的具体内容就是规定应用进程在通信时所遵循的协议。

#### 6.1 域名解析系统DNS

##### 6.1.1 域名系统概述

域名系统DNS（Domain Name System）是互联网使用的命名系统，用来把便于入门使用的机器名字转换成IP地址。
 因特网采用层次结构的命名树作为主机的名字，并使用**分布式的域名系统** DNS，大部分名字都在本地解析解析。名字到 IP 地址的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，运行该程序的机器称为**域名服务器**。

##### 6.1.2 互联网的域名结构

- 因特网采用了**层次树状结**构的命名方法。
- 任何一个连接在因特网上的主机或路由器，都有一个**唯一**的层次结构的名字，即域名。
- 域名的结构由标号序列组成，各标号之间用点
   隔开：
   … . 三级域名 . 二级域名 . 顶级域名
- 各标号分别代表不同级别的域名

![img](https://img-blog.csdnimg.cn/2020060111201763.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

##### 6.1.3 域名服务器

域名服务器有以下四种类型：

- **根域名服务器**：最高层次的域名服务器，根域名服务器是最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和 IP 地址
- **顶级域名服务器**：这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名。
- **权限域名服务器**：负责一个区的域名服务器。
- **本地域名服务器**： 当一个主机发出 DNS 查询请求时，这个查询请求报文就发送给本地域名服务器。

![img](https://img-blog.csdnimg.cn/20200601115402555.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

域名解析过程
 主机向本地域名服务器的查询一般都是采用递归查询。如果主机所询问的本地域名服务器不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户的身份，向其他根域名服务器继续发出查询请求报文。

![img](https://img-blog.csdnimg.cn/20200601120137382.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**域名解析测试**（nslookup指令）：

![img](https://img-blog.csdnimg.cn/20200601110238794.png?x-oss-process=imag)

#### 6.2 文件传输协议

##### 6.2.1 FTP概述

文件传送协议 FTP (File Transfer Protocol) 是因特网上使用得最广泛的文件传送协议。
 FTP协议的四个基本特点：

- 提供交互式的访问，使用户更容易通过操作系统命令与远程系统交互
- 允许客户指定存储文件的类型和格式
- 具备鉴别能力，允许文件有存取权限
- 屏蔽了计算机系统的细节，因而适合在异构的网络中任意计算机之间传送文件

##### 6.2.2 FTP 的基本工作原理

文件传送协议 FTP 只提供文件传送的一些基本的服务，它使用 **TCP 可靠的运输服务**。FTP 的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。
 FTP 使用**客户服务器方式**。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：一个**主进程**，负责接受新的请求；另外有若干个**从属进程**，负责处理单个请求。

主进程的**工作步骤**如下

- 打开熟知端口（端口号为 21），使客户进程能够连接上。
- 等待客户进程发出连接请求。
- 启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程。
- 回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发地进行。



在文件传输时，FTP的客户和服务器之间要建立两个并行的TCP连接：**控制连接和数据连接**。控制连接在整个会话期间一直保持打开，FTP 客户发出的传送请求通过控制连接发送给服务器端的控制进程，但控制连接不用来传送文件。实际用于传输文件的是“数据连接”。数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行。

![img](https://img-blog.csdnimg.cn/20200601210436433.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

FTP支持两种模式：Standard （PORT方式，主动方式），Passive （PASV，被动方式）。

- **Port模式**
   FTP 客户端首先和服务器的TCP **21端口**建立连接，用来发送命令，客户端需要接收数据的时候在这个通道上发送PORT命令。PORT命令包含了客户端用什么端口接收数据。在传送数据的时候，服务器端通过自己的TCP **20端口**连接至客户端的指定端口发送数据。FTP server必须和客户端建立一个新的连接用来传送数据。
- **Passive模式**
   建立控制通道和Standard模式类似，但建立连接后发送Pasv命令。服务器收到Pasv命令后，打开一个临时端口（端口号大于1023小于65535）并且通知客户端在这个端口上传送数据的请求，客户端连接FTP服务器此端口，然后FTP服务器将通过这个端口传送数据。

#### 6.3 远程终端协议TELNET

TELNET 是一个简单的远程终端协议， 用户用 TELNET 就可在其所在地通过 TCP 连接注册（即登录）到远地的另一个主机上（使用主机名或 IP 地址）。

为了适应不同计算机系统之间的差异，TELNET定义了**网络虚拟终端 NVT** ：

- 客户软件把用户的击键和命令转换成 NVT格式，并送交服务器。
- 服务器软件把收到的数据和命令，从 NVT格式转换成远地系统所需的格式。
- 向用户返回数据时，服务器把远地系统的格式转换为 NVT 格式，本地客户再从NVT 格式转换到本地系统所需的格式。

![img](https://img-blog.csdnimg.cn/20200601213414300.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

此外，telnet也可用于查看某个端口是否可访问。比如我们经常要用的端口就是 8080，那么你可以启动服务器，用telnet 去查看这个端口是否可用。连接失败则会提示，成功则会进入telnet页面（全黑）

![img](https://img-blog.csdnimg.cn/20200601213910489.png)

#### 6.4 万维网WWW

##### 6.4.1 万维网的概述

**万维网** WWW (World Wide Web)是一个大规模的、联机式的**信息储藏所**。万维网用**链接**的方法能非常方便地从因特网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息。

![img](https://img-blog.csdnimg.cn/20200604201314308.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

万维网是**分布式超媒体**(hypermedia)系统，它是**超文本**（hypertext)系统的扩充。

- **超文本**： 一个超文本由多个信息源链接成。利用一个链接可使用户找到另一个文档。
- **超媒体**：不仅包含文本，还包含其他表示方式的信息，如图形、图像、声音、动画，甚至活动视频图像。

万维网的工作方式

- 万维网以**客户服务器方式**工作。
- 浏览器就是在用户计算机上的**万维网客户程序**。万维网文档所驻留的计算机则运行服务器程序，因此这个计算机也称为**万维网服务器**。
- 客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档。
- 在一个客户程序主窗口上显示出的万维网文档称为**页面**(page)。

**万维网必须解决的问题**

- 怎样标志分布在整个因特网上的万维网文档？
  - 使用统一资源定位符 URL (Uniform ResourceLocator)来标志万维网上的各种文档。
  - 使每一个文档在整个因特网的范围内具有唯一的标识符 URL。
- 用何协议实现万维网上各种超链的链接？
  - 在万维网客户程序与万维网服务器程序之间进行交互所使用的协议，是超文本传送协议HTTP (HyperText Transfer Protocol)。
  - HTTP 是一个应用层协议，它使用 TCP 连接进行可靠的传送。
- 怎样使各种万维网文档都能在因特网上的各种计算机上显示出来，同时使用户清楚地知道在什么地方存在着超链？
  - 超文本标记语言 HTML (HyperText Markup Language)使得万维网页面的设计者可以很方便地用一个超链从本页面的某处链接到因特网上的任何一个万维网页面，并且能够在自己的计算机屏幕上将这些页面显示出来。
- 怎样使用户能够很方便地找到所需的信息？
  - 为了在万维网上方便地查找信息，用户可使用各种的搜索工具（即搜索引擎）。

##### 6.4.2 统一资源定位符 URL

统一资源定位符 URL 是对可以从因特网上得到的资源的位置和访问方法的一种简洁的表示。

**URL的格式**

由以**冒号隔开**的两大部分组成，并且在 URL中的字符对大写或小写没有要求。

![img](https://img-blog.csdnimg.cn/20200604202637178.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/20200604202737764.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/20200604202749523.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**使用 HTTP 的 URL**

使用 HTTP 的 URL 的一般形式：
 **http://<主机>:<端口>/<路径>**

例如清华大学的官网主页URL为：

> http://www.tsinghua.edu.cn/index.htm

开头指明了http，然后是主机域名，这里省略了端口号80，最后是路径名，一htm结尾表示是用超文本标记语言HTML写出的文件。

##### 6.4.3 超文本传送协议 HTTP

![img](https://img-blog.csdnimg.cn/20200604204428104.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

HTTP操作过程：

1. 浏览器分析超链指向页面的 URL。
2. 浏览器向 DNS 请求解析 www.tsinghua.edu.cn 的IP 地址。
3. 域名系统 DNS 解析出清华大学服务器的 IP 地址。
4. 浏览器与服务器建立 TCP 连接
5. 浏览器发出取文件命令：GET /chn/yxsz/index.htm。
6. 服务器给出响应，把文件 index.htm 发给浏览器。
7. TCP 连接释放。
8. 浏览器显示“清华大学院系设置”文件 index.htm中的所有文本。

**HTTP 的主要特点**

- HTTP 是面向事务的客户服务器协议。
- HTTP 1.0 协议是**无状态的**(stateless)。
- HTTP 协议本身也是无连接的，虽然它使用了面向连接的 TCP 向上提供的服务。
- HTTP/1.1 协议使用**持续连接**。

**持续连接的两种工作方式**

- 非流水线方式
- 流水线方式

![img](https://img-blog.csdnimg.cn/20200604205050555.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**代理服务器(proxy server)**

- 代理服务器(proxy server)又称为**万维网高速缓存**(Web cache)，它代表浏览器发出 HTTP 请求。
- 万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中。
- 当与暂时存放的请求相同的新请求到达时，万维网高速缓存就把暂存的响应发送出去，而不需要按 URL 的地址再去因特网访问该资源。

使用高速缓存可减少访问因特网服务器的时延

**HTTP 的报文结构**

HTTP 有两类报文：

- **请求报文**——从客户向服务器发送请求报文。
- **响应报文**——从服务器到客户的回答。

![img](https://img-blog.csdnimg.cn/20200604205908128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/20200604205929419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

- 开始行：用于区分请求报文和响应报文，
  - 方法用于表示实际的操作，URL，版本，CRLF分别代表“回车” 和“换行”，状态码表示返回的状态信息
- 首部行：用于说明浏览器、服务器或报文主体的一些信息
- 实体主体：一般不用这个字段

![img](https://img-blog.csdnimg.cn/2020060421055947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

![img](https://img-blog.csdnimg.cn/2020060421061117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

#### 6.5 电子邮件

电子邮件(e-mail)是因特网上使用得最多的和最受用户欢迎的一种应用。

发送邮件的协议：**SMTP**
 读取邮件的协议：**POP3 和 IMAP**

通用互联网邮件扩充**MIME** 在其邮件首部中说明了邮件的数据类型(如文本、声音、图像、视像等)，使用 MIME 可在邮件中同时传送多种类型的数据。

![img](https://img-blog.csdnimg.cn/20200604211034619.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

#### 6.6 动态主机配置协议DHCP

互联网的计算机协议软件需要配置的项目包括：

- IP地址
- 子网掩码
- 默认路由器的IP地址
- 域名服务器的IP地址

互联网广泛使用的是**动态主机配置协议DHCP**（Dynamic Host Configuration Protocol），它提供了一种**即插即用**的机制。

DHCP 使用**客户服务器**方式。并不是每个网络上都有 DHCP 服务器，这样会使 DHCP 服务器的数量太多。现在是每一个网络至少有一个 **DHCP 中继代理**，它配置了 DHCP 服务器的 IP 地址信息。

![img](https://img-blog.csdnimg.cn/20200601195849412.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

**DHCP 协议的工作过程**

1. DHCP 服务器被动打开 **UDP 端口 67**，等待客户端发来的报文。
2. DHCP 客户从 **UDP 端口 68**发送 DHCP 发现报文。
3. 凡收到 DHCP 发现报文的 DHCP 服务器都发出 DHCP 提供报文，因此 DHCP 客户可能收到多个 DHCP 提供报文。
4. DHCP 客户从几个 DHCP 服务器中选择其中的一个，并向所选择的 DHCP 服务器发送 DHCP 请求报文。
5. 被选择的 DHCP 服务器发送确认报文DHCPACK，进入已绑定状态，并可开始使用得到的临时 IP 地址了。
6. 租用期过了一半（T1 时间到），DHCP 发送请求报文 DHCPREQUEST 要求更新租用期。
7. DHCP 服务器若同意，则发回确认报文DHCPACK。DHCP 客户得到了新的租用期，重新设置计时器。
8. DHCP 服务器若不同意，则发回否认报文DHCPNACK。这时 DHCP 客户必须立即停止使用原来的 IP 地址，而必须重新申请 IP 地址（回到步骤2），若 DHCP 服 务 器 不 响 应 步 骤  的 请 求 报 文DHCPREQUEST ， 则 在 租 用 期 过 了87.5% 时 ，DHCP 客户必须重新发送请求报文DHCPREQUEST（重复步骤6），然后又继续后面的步骤。
9. DHCP 客户可随时提前终止服务器所提供的租用期，这时只需向 DHCP 服务器发送释放报文 DHCPRELEASE 即可。

![img](https://img-blog.csdnimg.cn/20200601200540781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

通过ipconfig指令查看DHCP动态配置IP地址：

![img](https://img-blog.csdnimg.cn/20200601200836773.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)

我们可以通过ipconfig/realse主动将连接释放，然后通过ipconfig/renew再次获取IP地址：

![img](https://img-blog.csdnimg.cn/20200601201010460.png)

![img](https://img-blog.csdnimg.cn/20200601201217643.png)

再次查看IP地址的分配：

![img](https://img-blog.csdnimg.cn/20200601201312885.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MjYwNzY3,size_16,color_FFFFFF,t_70)





### 常见问题总结

1. 数据链路层: 
      \- 数据链路层为网络层提供可靠的数据传输；
      \- 基本数据单位为帧；
      \- 主要的协议：以太网协议；

   ​    \- 两个重要设备名称：网桥和交换机。常见的交换机有**以太网交换机**。 

   

     A,B中的中继器（Repeater）和集线器（Hub）是物理层的，路由器是网络层的

2. UDP**的特点如下**： 

     （1）无链接 

     （2）UDP使用尽最大努力交付，不保证可靠性 

     （3）UDP是面向报文的，UDP对应用层交付下来的报文，既不合并，也不拆分，而是保留这些报文的边界。应用层交给UDP多长的报文，UDP就照样发送，即一次发送一个报文 

     （4）UDP没有拥塞控制 

     **（5）UDP支持一对一、一对多、多对一和多对多的交互通信**

     （6）UDP的首部开销小，只有8字节 

   

     TCP**的特点**： 

     （1）TCP是面向连接的 

     （2）每条TCP连接只能用于两个断点，一对一 

     （3）TCP提供可靠交付的服务：连接传输数据、无差错、不丢失、不重复、并且按序到达 

     （4）TCP提供全双工通信 

     （5）面向字节流。TCP根据对方给出的窗口和当前网络拥塞的程度来决定一个报文应该包含多少个字节 

   

     **TCP如何提供可靠性的连接：** 

     （1）数据被分割成TCP认为最合适发送的数据块 

     （2）重传机制：TCP发出一个段后，启动定时器，如果不能及时收到报文段，则重发一个报文段 

     （3）当TCP收到一个段后，会发送一个确认 

     （4）TCP将保持它首部和数据的校验和 

     （5）TCP对收到的数据进行重新排序，保证数据的有序 

     （6）TCP会丢弃重复的数据 

     （7）TCP提供流量控制 